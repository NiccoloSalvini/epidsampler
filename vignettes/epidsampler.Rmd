---
title: "Simulate an epidemic map with mobility and social interaction between individuals"
author: "Vincenzo Nardelli"
date: "02/09/2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{epidsampler}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(epidsampler)
```

The simulation is divided in two main function. We generate the map (regular grid or irregular map) and the individuals using generate(). Then, for each day of the simulation, we simulate the mobility, social interaction and the evolution of the epidemics with the infection and evolution of the disease for each individual in the map.

# Map generation
It is possible to generate two different types of maps:

- regular map or grid

- irregular map or polygon


## Regular grid map

```{r}
set.seed(12345)
map <- generate(n=25, P=1000, type="grid")
print(map)
```

## Irregular map

```{r}
set.seed(12345)
map <- generate(n=25, P=1000, type="polygon")
print(map)
```

#### Parameters:

- **n** spatial clusters
- **p** people density min/max - uniform distribution

For the *grid* map generation we considered a population distributed into **n** spatial units laid on a regular squared lattice grid. For *polygon* map generation we considered a population distributed in **n** spatial clusters. Each square of the grid contains a number of individuals randomly drawn from a uniform distribution ranging between the two values contained in the vector **p**. This geographical representation is very general in that the map thus generated can represent, e. g., a city divided into blocks or a region divided into smaller spatial union or any other meaningful geographical partition.

# Simulation

## Mobility
#### Parameters:

- **m** % of moving individuals
- **s** max step size (grid map) / number of neighbor clusters (polygon map)

The contagion mechanism is favoured by people mobility. In this simulation, we assumed that in any moment of time a certain percentage **m** of the population can move between the spatial clusters. In this way it is possible to distinguish different epidemic phases such as free-to-move period and lockdown. The commuting during the lockdown period is not only limited by the number of people who move, but also by the extent of their movements. In the case of grid map, the parameter **s** rules the max step size between the tiles of the grid. In the case of the polygon map, the parameter **s** rules the number of neighbor clusters in which each individual can move.


## Social interaction
#### Parameters:

- **cn** mean of contacts inside a spatial cluster
- **cp** mean of number of people for each contact
- **im** mean of number of people infected

Given the mobility pattern described above, contagion is determined by the social interaction and the contact opportunities. The number of contacts in spatial cluster is assumed to be determined by a random number drawn from a Poisson distribution with parameter, say **cn**, while the number of people involved in the movements is also a Poisson number characterised but a different parameter **cp**. Given these assumptions, a contagion occurs in the following way. If in a meeting it is present at least one asymptomatic or an exposed person, **im** susceptibles will be infected moving in the status of the Exposed.


## Evolution of the epidemics
#### Classification of individuals:

- **S** subsceptible
- **E** exposed
- **I** infected
- **R** removed
- **D** death                            
- **A** asyntomatic

#### Parameters:

- **tE** number of days of E condition
- **tI** number of days of I condition
- **tA** number of days of A condition
- **ir** infected rate I/(A+I)
- **cfr** case fatality rate


First of all, in order to simulate an artificial population describing the time evolution of an epidemics, we considered a popular model constituted by a system of six differential equations which, in each moment of time, describe six categories of individuals, namely: the susceptibles (S), those exposed to the virus (E), the infected with symptoms (I), those without symptoms (A) and those that are removed from population either because healed (R) or dead (D). This modelling framework is due to the seminal contribution of Hamer (1906), Kermack and McKendrick (1927) and Soper (1929) and it is often referred to as the “SIR model” from the initials of the categories considered in the first simplified formulation: Susceptibles, Infected and Removed. A comprehensive overview of this model is contained in Cliff et al. (1981). See also Vynnycky and White (2010). 

For the data random generation, we assumed that, if infected, a susceptible element of the population (S) will remain in the exposed state (E) for the time **tE**. After that period the subject can become either infected with symptoms (I) with probability **ir** or without (asymptomatic; symbol A) with probability **1-ir**. The asymptomatic will remain infected (and so still able to transmit the virus) for **tA** days. After this period all the asymptomatic will be considered healed and will pass to the category removed (R). In contrast, the infected people showing symptoms will be healed with probability **1-cfr** or die (D) with probability **cfr** (case death rate). 

The first simulation does not consider asyntomatic in the evolution of the epidemics, i.e. **ir = 1**. 

```{r message=FALSE, warning=FALSE}
phase1 <- . %>%
  move_uniform(m=0.2, s=3) %>%
  meet(cn=3, cp=4, im=2) %>%
  move_back()

map <- run(map, phase1, days = 21, tE=5, tA=14,
            tI=14, ir=1, cfr=0.15)

```

And add different parameters for the second phase.

```{r message=FALSE, warning=FALSE}
phase2 <- . %>%
  move_uniform(m=0.01, s=1) %>%
  meet(cn=2, cp=3, im=1) %>%
  move_back()

map <- run(map, phase2, days = 21, ir=1)
plot(map)     
```


